#!/bin/bash

set -e

PLAYLISTS=(
	# FILEPATH NAME SCALE {FILTER}
#	"playlist 8"
	"$HOME/main.awp list-64 64"
	"$HOME/main.awp list-32 32"
	"$HOME/main.awp list-64u 64 uniq"
	"$HOME/main.awp list-128u 128 uniq"
	"$HOME/main.awp list-16 16"
	"$HOME/music/playlists/soft.awp soft-32 32"
)

# Format note: phone won't recognize .opus files, but they're the same container format as .ogg
# so we create .ogg files that use the opus codec explicitly.
awk -F'\t' '$1 >= 16 {print $3}' ~/main.awp |
transcode-cp --stdin --safe --ext=ogg "$@" ~/music/ /srv/btsync/music/ -- -vn -b:a 64k -codec:a libopus

for line in "${PLAYLISTS[@]}"; do
	read path name scale filter <<<"$line"
	[ -n "$filter" ] || filter=cat
	python -m awp.to_m3u "$path" ~/music/ . --scale="$scale" |
	$filter | sed 's/\.[^.]\+$/.ogg/' |
	LC_ALL=C sed -e 's|[^a-zA-Z0-9/ .-]|_|g' -e 's|^file_//|file://|' >"/srv/btsync/music/$name.m3u"
done
